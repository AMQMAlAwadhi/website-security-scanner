#!/usr/bin/env python3
"""
Unified Vulnerability Data Model

Standard vulnerability data structure for the website-security-scanner.
This model ensures consistent data structures across CLI, web interface, and scanner core.

Author: Bachelor Thesis Project - Low-Code Platforms Security Analysis
"""

from dataclasses import dataclass, field, asdict
from typing import Dict, List, Optional, Any, Union
from datetime import datetime
import uuid


@dataclass
class Vulnerability:
    """
    Unified vulnerability data structure.

    This is the standard vulnerability model used across all components of the
    security scanner. It ensures consistent representation of vulnerabilities
    across analyzers, transformers, report generators, and interfaces.

    Fields:
        id: Unique identifier for the vulnerability
        title: Vulnerability title/name
        severity: Severity level (Critical, High, Medium, Low, Info)
        confidence: Confidence level (Certain, Firm, Tentative)
        description: Detailed description of the vulnerability
        evidence: Evidence supporting the finding (string, dict, or list)
        instances: List of HTTP request/response instances
        category: Vulnerability category
        cwe: List of relevant CWE identifiers
        references: List of reference URLs for more information
        verification: Verification results from active testing
        background: Background information about the vulnerability type
        impact: Detailed impact analysis
        recommendation: Remediation recommendations
        owasp: OWASP classification
        parameter: Affected parameter name (for verification)
        url: Target URL where vulnerability was found
        timestamp: ISO format timestamp when vulnerability was found
        platform: Platform where vulnerability was detected
        extra_fields: Additional platform-specific fields
    """
    id: str
    title: str
    severity: str
    confidence: str
    description: str
    evidence: Union[str, Dict, List] = ""
    instances: List[Dict[str, Any]] = field(default_factory=list)
    category: str = "General"
    cwe: List[str] = field(default_factory=list)
    references: List[str] = field(default_factory=list)
    verification: Dict[str, Any] = field(default_factory=dict)
    background: str = ""
    impact: str = ""
    recommendation: str = ""
    owasp: str = "N/A"
    parameter: str = ""
    url: str = ""
    timestamp: str = ""
    platform: str = ""
    extra_fields: Dict[str, Any] = field(default_factory=dict)

    def __post_init__(self):
        """Generate ID and timestamp if not provided."""
        if not self.id:
            self.id = str(uuid.uuid4())
        if not self.timestamp:
            self.timestamp = datetime.now().isoformat()

    def to_dict(self) -> Dict[str, Any]:
        """
        Convert to dictionary for JSON serialization.

        Returns:
            Dictionary representation of the vulnerability
        """
        result = asdict(self)
        # Normalize evidence to ensure consistent serialization
        if isinstance(result['evidence'], (dict, list)):
            result['evidence'] = result['evidence']
        else:
            result['evidence'] = result['evidence'] or ""
        return result

    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'Vulnerability':
        """
        Create Vulnerability from dictionary.

        Args:
            data: Dictionary containing vulnerability data

        Returns:
            Vulnerability instance
        """
        # Extract known fields
        known_fields = {
            'id', 'title', 'severity', 'confidence', 'description',
            'evidence', 'instances', 'category', 'cwe', 'references',
            'verification', 'background', 'impact', 'recommendation',
            'owasp', 'parameter', 'url', 'timestamp', 'platform', 'extra_fields'
        }

        # Separate known and extra fields
        vuln_data = {k: v for k, v in data.items() if k in known_fields}
        extra_data = {k: v for k, v in data.items() if k not in known_fields}

        # Set defaults for required fields
        vuln_data.setdefault('id', '')
        vuln_data.setdefault('title', data.get('type', 'Unnamed Vulnerability'))
        vuln_data.setdefault('severity', 'Info')
        vuln_data.setdefault('confidence', 'Tentative')
        vuln_data.setdefault('description', '')
        vuln_data.setdefault('evidence', data.get('evidence', ''))
        vuln_data.setdefault('instances', data.get('instances', []))
        vuln_data.setdefault('category', 'General')
        vuln_data.setdefault('cwe', data.get('cwe', []))
        vuln_data.setdefault('references', data.get('references', []))
        vuln_data.setdefault('verification', data.get('verification', {}))
        vuln_data.setdefault('background', data.get('background', ''))
        vuln_data.setdefault('impact', data.get('impact', ''))
        vuln_data.setdefault('recommendation', data.get('recommendation', ''))
        vuln_data.setdefault('owasp', data.get('owasp', 'N/A'))
        vuln_data.setdefault('parameter', data.get('parameter', ''))
        vuln_data.setdefault('url', data.get('url', ''))
        vuln_data.setdefault('timestamp', data.get('timestamp', ''))
        vuln_data.setdefault('platform', data.get('platform', ''))
        vuln_data.setdefault('extra_fields', extra_data)

        return cls(**vuln_data)

    @classmethod
    def from_basic_dict(cls, data: Dict[str, Any], platform: str = "") -> 'Vulnerability':
        """
        Create Vulnerability from basic analyzer dict format.

        This method converts the old-style vulnerability dicts used by analyzers
        into the unified Vulnerability model.

        Args:
            data: Basic vulnerability dict from analyzer
            platform: Platform where vulnerability was detected

        Returns:
            Vulnerability instance
        """
        return cls(
            id=str(uuid.uuid4()),
            title=data.get('type', 'Unnamed Vulnerability'),
            severity=data.get('severity', 'Info'),
            confidence=data.get('confidence', 'Tentative'),
            description=data.get('description', ''),
            evidence=data.get('evidence', ''),
            instances=data.get('instances', []),
            category=data.get('category', 'General'),
            cwe=data.get('cwe', []),
            references=data.get('references', []),
            verification=data.get('verification', {}),
            background=data.get('background', ''),
            impact=data.get('impact', ''),
            recommendation=data.get('recommendation', ''),
            owasp=data.get('owasp', 'N/A'),
            parameter=data.get('parameter', ''),
            url=data.get('url', ''),
            timestamp=data.get('timestamp', datetime.now().isoformat()),
            platform=platform or data.get('platform', '')
        )

    def to_basic_dict(self) -> Dict[str, Any]:
        """
        Convert to basic dict format for backward compatibility.

        Returns:
            Dictionary in the old-style format used by analyzers
        """
        return {
            'type': self.title,
            'severity': self.severity,
            'description': self.description,
            'evidence': self.evidence,
            'recommendation': self.recommendation,
            'confidence': self.confidence,
            'category': self.category,
            'owasp': self.owasp,
            'cwe': self.cwe,
            'parameter': self.parameter,
            'url': self.url,
            'timestamp': self.timestamp,
            'instances': self.instances,
            'background': self.background,
            'impact': self.impact,
            'references': self.references,
            'verification': self.verification,
            'platform': self.platform,
            **self.extra_fields
        }
